{% extends 'base.html' %}
{% load static %}

{% block seo_title %} {{ service.seo_title }} {% endblock %}
{% block seo_description %} {{ service.seo_description }} {% endblock %}

{% block og_title %} {{ service.seo_title }} {% endblock %}
{% block og_description %} {{ service.seo_description }} {% endblock %}

{% block content %}

<style>
  /* Контейнеры скрывают «хвост» трека */
  #galleryContainer, #partnersContainer { overflow: hidden; }

  /* Треки — в одну линию, без схлопывания, с подсказкой браузеру */
  #infiniteGallery, #partnersTrack {
    display: flex;
    gap: 1rem;
    will-change: transform;
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* Во время драга курсор и мягкое отключение «прилипаний» */
  #galleryContainer.is-dragging, #partnersContainer.is-dragging { cursor: grabbing; }

  /* Карточки не должны сжиматься (иначе на iOS скачет ширина) */
  .gallery-item, .partner-card { flex-shrink: 0; }

  /* Изображения — без миганий слоёв */
  .gallery-item img { display:block; -webkit-transform: translateZ(0); }
</style>

<section class="hero">
  <div class="pt-[4.5rem]">
    <div class="text-center flex flex-col gap-3">
      <h3 class="text-gray-500 md:text-lg text-sm uppercase tracking-widest text-accent-500">Dana Nurzhuma Event</h3>
      <h1 class="h1 font-bold text-green-600">{{ service.hero_title|safe }}</h1>
      <h2 class="text-gray-500 md:text-lg">{{ service.hero_subtitle|safe }}</h2>
    </div>
    {% if service.hero_button_text %}
    <div class="flex justify-center py-8">
      <button class="btn-main" data-open-form data-source="Кнопка {{ service.hero_button_link }}">{{ service.hero_button_text }}</button>
    </div>
    {% endif %}
    <div class="flex justify-center pb-4 pt-14 border-b-1 border-gray-300">
      <div class="gallery-container" id="galleryContainer">
        <div class="gallery-track auto-scroll" id="infiniteGallery">
          <!-- Изображения будут добавлены через JavaScript -->
        </div>
      </div>
    </div>
  </div>
</section>

{% if service.about %}
<section class="py-16">
  <div class="grid grid-cols-12 gap-4 px-4">
    <div class="lg:col-span-4 col-span-full">
      <h1 class="text-gray-500 text-xl uppercase tracking-wider font-bold">О НАС</h1>
    </div>
    <div class="lg:col-span-8 col-span-full">
      <h1 class="md:text-4xl md:leading-11 text-3xl font-semibold">{{ service.about.title|safe }}</h1>
      <div class="w-full xl:max-w-[85%] pt-6 pb-8">
        <div class="text-gray-500 md:text-lg md:columns-2 gap-12 leading-5.5 [hyphens:auto] [word-break:break-word]">
          {{ service.about.description }}
        </div>
      </div>
      <button class="btn-outline" data-open-form data-source="Кнопка Заказать проект - услуги {{ service.hero_subtitle }}">Заказать проект</button>

      <div class="pt-16">
        <ul class="grid md:grid-cols-4 grid-cols-2 md:gap-4 gap-y-12 gap-x-4">
            {% for benefit in service.about.benefits.all %}
              <li class="flex flex-col justify-between gap-8 border-blue-900">
                <span class="text-gray-500 md:text-xl text-accent-500 leading-6">{{ benefit.title|safe }}</span>
                <span class="text-black md:text-5xl text-4xl font-mono font-medium">{{ benefit.number|safe }}</span>
              </li>
            {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</section>
{% endif %}

<section class="py-8 border-y-1  border-gray-300">
  <div class="partners-container" id="partnersContainer">
    <div class="partners-track auto-scroll" id="partnersTrack">
      <!-- Карточки будут добавлены через JavaScript -->
    </div>
  </div>
</section>

{% if service.items.all %}
<section class="pt-9 pb-12">
    <div class="grid grid-cols-12 gap-4 px-4 py-6">
      <div class="lg:col-span-4 col-span-full">
        <span class="text-gray-500 text-xl uppercase font-semibold tracking-wider">Услуги</span>
      </div>
      <div class="lg:col-span-8 col-span-full">
        <h1 class="md:text-4xl md:leading-11 text-3xl font-semibold">{{ service.service_title|safe }}</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-14 pt-14">
            {% for item in service.items.all %}
            <div>
                <span class="mb-6">
                  {{ item.svg_path|safe }}
                </span>
                <h3 class=" font-bold text-black text-xl pt-6 pb-2">{{ item.title|safe }}</h3>
                <p class="text-gray-500 leading-5">{{ item.description|safe }}</p>
            </div>
            {% endfor %}

        </div>
      </div>
    </div>
</section>
{% endif %}

{% if service.location %}
<section class="pt-9 pb-12 border-t border-gray-300">
  <div class="grid grid-cols-12 gap-4 px-4 py-6">
    <div class="lg:col-span-4 col-span-full">
      <span class="text-gray-500 text-xl uppercase font-semibold tracking-wider">Локация</span>
    </div>
    <div class="lg:col-span-8 col-span-full">
      <h1 class="md:text-4xl md:leading-11 text-3xl font-semibold">{{ service.location.title }}</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-6">
        <div>
          <img src="{{ service.location.image.url }}" class="w-full" alt="">
        </div>
        <div class="md:w-[80%] w-full">
          <p class="text-gray-500">{{ service.location.description }}</p>

          <div class="py-8">
            <a href="{{ service.location.button_link }}" class="btn-outline">{{ service.location.button_text }}</a>
          </div>

        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}


<script>
(() => {
  // Универсальная бесконечная «маркиза» с авто-прокруткой и перетаскиванием.
  function initMarquee({ containerSel, trackSel, items, renderItem, speed = 36 }) { // speed: px/сек
    const $container = document.querySelector(containerSel);
    const $track = document.querySelector(trackSel);
    if (!$container || !$track || !items || !items.length) return;

    // Рендер: один проход + дубликат (для бесшовности). Ширина карточек фиксирована → можно считать сразу.
    const html = items.map(renderItem).join("");
    $track.innerHTML = html + html;

    // На всякий случай доклонируем, если контента мало (учтём ширину контейнера).
    while ($track.scrollWidth < $container.offsetWidth * 2) {
      $track.insertAdjacentHTML("beforeend", html);
    }

    // Состояние
    let x = 0;
    let down = false;
    let startX = 0;
    let startXWorld = 0;
    let lastTs = 0;
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let autoplay = !prefersReduced;
    let contentW = $track.scrollWidth / 2; // ширина «одного цикла»

    // Главный цикл
    function loop(ts) {
      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      if (autoplay && !down) x -= speed * dt;

      // Бесшовная подмена
      if (x <= -contentW) x += contentW;
      if (x > 0) x -= contentW;

      $track.style.transform = `translate3d(${x}px, 0, 0)`;
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ————— Drag & Touch —————
    const opts = { passive: false }; // критично для iOS Safari
    const onDown = (e) => {
      down = true;
      autoplay = false;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
      startXWorld = x;
      $container.classList.add('is-dragging');
    };
    const onMove = (e) => {
      if (!down) return;
      e.preventDefault(); // иначе iOS начнёт нативный скролл/«подпрыгивать»
      const cur = (e.touches ? e.touches[0].clientX : e.clientX);
      x = startXWorld + (cur - startX);
    };
    const onUp = () => {
      if (!down) return;
      down = false;
      $container.classList.remove('is-dragging');
      setTimeout(() => { autoplay = !prefersReduced; }, 800); // мягкий автопуск
    };

    // Pointer Events там, где доступны (современно и надёжно)
    if ('PointerEvent' in window) {
      $container.addEventListener('pointerdown', onDown, opts);
      window.addEventListener('pointermove', onMove, opts);
      window.addEventListener('pointerup', onUp, opts);
      // Разрешаем вертикальный скролл страницы, блокируя горизонтальные жесты
      $container.style.touchAction = 'pan-y';
      $container.style.cursor = 'grab';
    } else {
      // Фоллбек для очень старых браузеров
      $container.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
      $container.addEventListener('touchstart', onDown, opts);
      window.addEventListener('touchmove', onMove, opts);
      window.addEventListener('touchend', onUp);
    }

    // Если контент/шрифты перерисовались (редко), пересчитай ширину цикла
    const ro = new ResizeObserver(() => { contentW = $track.scrollWidth / 2; });
    ro.observe($track);
  }

  // ========== Инициализация Галереи ==========
  {% if service.gallery.all %}
  const galleryItems = [
    {% for item in service.gallery.all %}
      { image:'{{ item.image.url }}',
        title:'{{ item.title|escapejs }}',
        description:'{{ item.description|escapejs }}',
        type:'{{ item.orientation }}' },
    {% endfor %}
  ];
  initMarquee({
    containerSel: '#galleryContainer',
    trackSel: '#infiniteGallery',
    items: galleryItems,
    speed: 38, // можно подстроить
    renderItem: (it) => {
      const h = (it.type === 'tall') ? 'h-80 md:h-96' : 'h-64 md:h-80';
      return `
        <div class="gallery-item w-64 md:w-80">
          <div class=" overflow-hidden">
            <img src="${it.image}" alt="${it.title}" class="w-full ${h} object-cover" decoding="async">
          </div>
          ${it.description ? `<div class="py-2"><p class="text-gray-500 text-sm italic">${it.description}</p></div>` : ''}
        </div>
      `;
    }
  });
  {% endif %}

  // ========== Инициализация Партнёров ==========
  {% if partners %}
  const partnersData = [
    {% for partner in partners %}
      { name:'{{ partner.name|escapejs }}',
        bgColor:'{{ partner.color }}',
        svg:`{{ partner.svg_path|escapejs }}` },
    {% endfor %}
  ];
  initMarquee({
    containerSel: '#partnersContainer',
    trackSel: '#partnersTrack',
    items: partnersData,
    speed: 32,
    renderItem: (p) => `
      <div class="partner-card rounded-xl p-6 flex items-center justify-center" style="background-color:${p.bgColor}">
        ${p.svg}
      </div>
    `
  });
  {% endif %}
})();
</script>


{% endblock %}